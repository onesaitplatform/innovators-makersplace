<!DOCTYPE html>
<html lang="en">

<head>
	<title>Market Place IoT</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!--===============================================================================================-	
	<link rel="icon" type="image/png" href="images/icons/favicon.ico"/>-->
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="vendor/bootstrap/css/bootstrap.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="fonts/font-awesome-4.7.0/css/font-awesome.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="fonts/Linearicons-Free-v1.0.0/icon-font.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="vendor/animate/animate.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="vendor/css-hamburgers/hamburgers.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="vendor/animsition/css/animsition.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="vendor/select2/select2.min.css">
	<!--===============================================================================================	
	<link rel="stylesheet" type="text/css" href="vendor/daterangepicker/daterangepicker.css">-->
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="css/util.css">
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<!--===============================================================================================-->


	<style>
		* {
			box-sizing: border-box;
		}


		.heading {
			font-size: 25px;
			margin-right: 25px;
		}

		.fa {
			font-size: 25px;
		}

		.checked {
			color: orange;
		}

		/* Three column layout */
		.side {
			float: left;
			width: 15%;
			margin-top: 10px;
		}

		.middle {
			float: left;
			width: 70%;
			margin-top: 10px;
		}

		/* Place text to the right */
		.right {
			text-align: right;
		}

		/* Clear floats after the columns */
		.row:after {
			content: "";
			display: table;
			clear: both;
		}

		/* The bar container */
		.bar-container {
			width: 100%;
			background-color: #f1f1f1;
			text-align: center;
			color: white;
		}

		/* Individual bars */
		.bar-5 {
			
			height: 18px;
			background-color: #4CAF50;
		}

		.bar-4 {
		
			height: 18px;
			background-color: #2196F3;
		}

		.bar-3 {
			
			height: 18px;
			background-color: #00bcd4;
		}

		.bar-2 {
			
			height: 18px;
			background-color: #ff9800;
		}

		.bar-1 {
			
			height: 18px;
			background-color: #f44336;
		}
		.bar-0 {
			
			height: 18px;
			background-color: rgb(182, 18, 18);
		}

		/* Responsive layout - make the columns stack on top of each other instead of next to each other */


		.rating {
			display: inline-block;
			position: relative;
			height: 50px;
			line-height: 50px;
			font-size: 50px;
		}

		.rating label {
			position: absolute;
			top: 0;
			left: 0;
			height: 100%;
			cursor: pointer;
		}

		.rating label:last-child {
			position: static;
		}

		.rating label:nth-child(1) {
			z-index: 5;
		}

		.rating label:nth-child(2) {
			z-index: 4;
		}

		.rating label:nth-child(3) {
			z-index: 3;
		}

		.rating label:nth-child(4) {
			z-index: 2;
		}

		.rating label:nth-child(5) {
			z-index: 1;
		}

		.rating label input {
			position: absolute;
			top: 0;
			left: 0;
			opacity: 0;
		}

		.rating label .icon {
			float: left;
			color: transparent;
		}

		.rating label:last-child .icon {
			color: #000;
		}

		.rating:not(:hover) label input:checked~.icon,
		.rating:hover label:hover input~.icon {
			color: #09f;
		}

		.rating label input:focus:not(:checked)~.icon:last-child {
			color: #000;
			text-shadow: 0 0 5px #09f;
		}
	</style>


</head>

<body>

	<div class="limiter">
		<nav class="navbar navbar-expand-lg navbar-light bg-light navbar-fixed-top" style="height: 80px; background-color: #cffcc7 !important;">
			<a class="navbar-brand" href="main.html">MARKET PLACE IOT MAKERS 3D</a>

			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown"
				aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>

			<div class="collapse navbar-collapse pull-right" id="navbarNavDropdown">
				<ul class="navbar-nav ">
					<li class="nav-item">
						<a class="nav-link" href="create.html"><span class="lnr lnr-plus-circle"></span> Crear</a>
					</li>
					<li class="nav-item dropdown">
						<a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown"
							aria-haspopup="true" aria-expanded="false">
							<span class="lnr lnr-user"></span> rtvachet
						</a>
						<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">

							<a class="dropdown-item disabled" href="#">Información personal</a>
							<a class="dropdown-item" href="index.html">Cerrar sesión</a>
						</div>
					</li>
				</ul>
			</div>
			<div id="spinnermain" class="spinner-grow text-dark" style="display:none;height: 20px; width:  20px;"
				role="status">
				<span class="sr-only">Loading</span>
			</div>
		</nav>
		<div class="container-fluid">
			<div id="market-elements" class="row" style="margin-top: 50px;">
			</div>
			<div id="valorar" class="row" style="margin-top: 50px;">
				<div class="col-12">
					<div id="creacionCorrecta" style="display:none" class="alert alert-success"
										role="alert">
										<h5>¡¡ Se ha enviado la valoración correctamente !!</h5>
									</div>
									<div id="creacionFallida" style="display:none" class="alert alert-danger"
										role="alert">
										<h5>Se ha producido un error al enviar la valoración, intento de nuevo y si el problema
											persiste intentelo pasado unos minutos.</h5>
									</div>
					<div class="card">
						<div class="card-body">
							<div class="rating">
								<label>
									<input type="radio" name="stars" value="1" />
									<span class="icon">★</span>
								</label>
								<label>
									<input type="radio" name="stars" value="2" />
									<span class="icon">★</span>
									<span class="icon">★</span>
								</label>
								<label>
									<input type="radio" name="stars" value="3" />
									<span class="icon">★</span>
									<span class="icon">★</span>
									<span class="icon">★</span>
								</label>
								<label>
									<input type="radio" name="stars" value="4" />
									<span class="icon">★</span>
									<span class="icon">★</span>
									<span class="icon">★</span>
									<span class="icon">★</span>
								</label>
								<label>
									<input type="radio" name="stars" value="5" />
									<span class="icon">★</span>
									<span class="icon">★</span>
									<span class="icon">★</span>
									<span class="icon">★</span>
									<span class="icon">★</span>
								</label>

							</div>
							<input type="text" class="form-control" placeholder="Puede añadir aqui una valoración"
								id="comentarioValoracion">
							<div class="pull-right">
								<input value="Valorar" type="button" class="login100-form-btn"
									style="min-width: 84px;width: 100px;     margin-top: 20px;" onclick="enviarValoracion()" />
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!--===============================================================================================-->
	<script src="vendor/jquery/jquery-3.2.1.min.js"></script>
	<!--===============================================================================================-->
	<script src="vendor/animsition/js/animsition.min.js"></script>
	<!--===============================================================================================-->
	<script src="vendor/bootstrap/js/popper.js"></script>
	<script src="vendor/bootstrap/js/bootstrap.min.js"></script>
	<!--===============================================================================================-->
	<script src="vendor/select2/select2.min.js"></script>
	<!--===============================================================================================-->
	<script src="vendor/daterangepicker/moment.min.js"></script>
	<script src="vendor/daterangepicker/daterangepicker.js"></script>
	<!--===============================================================================================-->
	<script src="vendor/countdowntime/countdowntime.js"></script>
	<!--===============================================================================================-->
	<script src="js/main.js"></script>


	<script>
		var id = '';

		function init() {
			$('#spinnermain').show();
			const queryString = window.location.search;
			const urlParams = new URLSearchParams(queryString);
			id = urlParams.get('id');
			var settings = {
				"url": "https://lab.onesaitplatform.com/api-manager/server/api/v1/Market3D_asset/get/" + id,
				"method": "GET",
				"timeout": 0,
				"headers": {
					"X-OP-APIKey": "b2fd5ceda7154eecb401886f461a6f0a"
				},
				"processData": false,
				"mimeType": "multipart/form-data",
				"contentType": false
			};

			$.ajax(settings).fail(function () {

				$('#spinnermain').hide();
			}).done(function (response) {
				var data = JSON.parse(response);
				console.log(response);

				draw(data);
			});
		}

		function draw(element) {



			var elemhtml = `<div class="col-12"><div class="card"    >
						<div  class="text-center">
						<img class="card-img-top class="rounded mx-auto d-block" style="max-width:500px"  src="${element.images[0]}?disposition=x&x-op-apikey=b2fd5ceda7154eecb401886f461a6f0a">
						</div>
						<div class="card-body">
							<h5 class="card-title">${element.name}</h5>
							<div class="row">
								<div class="col-10">
									<p class="card-text">${element.description}</p>
								</div>
								<div class="col-2">
									<div class="container-login100-form-btn">
										<a  class="login100-form-btn" href="${element.file}" download="proposed_file_name">Download</a>
								</div>
							</div>
							</div>
							<hr/>
							<div class="row">
								<div class="col-12">
								<p class="card-text">${element.summary}</p>
							</div>
							</div>
							<hr/>
							<div id="ratings" class="row">								
							</div>
						</div>
					</div>
					</div> `;
			$('#market-elements').append(elemhtml);


			if (typeof element.ratings != 'undefined' && element.ratings != null && element.ratings.length > 0) {
				$('#ratings').append('<h5 style="margin-left: 14px;">Valoraciones</h5></br>');
				var puntuaciones=[0,0,0,0,0,0];
				element.ratings.forEach(rating => {
					var ratinghtml = `  
			<div class="col-12">
							</br>
								<h6>${rating.Marketplace3DComments.user}</h6>
								<p class="card-text">${rating.Marketplace3DComments.comment}</p>

							 
						</div>

						 `
						 puntuaciones[rating.Marketplace3DComments.rating ]=puntuaciones[rating.Marketplace3DComments.rating ]+1;
					$('#ratings').append(ratinghtml);
				});

			}

		 var calc = 1;
			if(element.ratings.length>0){
				calc = 100 /element.ratings.length ;
			}
			var val = `<div class="col-md-6 offset-md-3" id="valoraciones">	
				</br></br>
				<div class="row">
				  <div class="side">
					<div>5 star</div>
				  </div>
				  <div class="middle">
					<div class="bar-container progress m-progress--sm">
						<div class="bar-5 progress-bar m--bg-brand" role="progressbar" width="0%" aria-valuenow="${puntuaciones[5]*calc}" aria-valuemin="0" aria-valuemax="${element.ratings.length}"></div>
					</div>
				  </div>
				  <div class="side right">
					<div>${puntuaciones[5]}</div>
				  </div>
				  <div class="side">
					<div>4 star</div>
				  </div>
				  <div class="middle">
					<div class="bar-container progress m-progress--sm">
						<div class="bar-4 progress-bar m--bg-brand" role="progressbar" width="0%" aria-valuenow="${puntuaciones[4]*calc}" aria-valuemin="0" aria-valuemax="${element.ratings.length}"></div>
					</div>
				  </div>
				  <div class="side right">
					<div>${puntuaciones[4]}</div>
				  </div>
				  <div class="side">
					<div>3 star</div>
				  </div>
				  <div class="middle">
					<div class="bar-container progress m-progress--sm">
						<div class="bar-3 progress-bar m--bg-brand" role="progressbar" width="0%" aria-valuenow="${puntuaciones[3]*calc}" aria-valuemin="0" aria-valuemax="${element.ratings.length}"></div>
					</div>
				  </div>
				  <div class="side right">
					<div>${puntuaciones[3]}</div>
				  </div>
				  <div class="side">
					<div>2 star</div>
				  </div>
				  <div class="middle">
					<div class="bar-container progress m-progress--sm">
						<div class="bar-2 progress-bar m--bg-brand" role="progressbar" width="0%" aria-valuenow="${puntuaciones[2]*calc}" aria-valuemin="0" aria-valuemax="${element.ratings.length}"></div>
					</div>
				  </div>
				  <div class="side right">
					<div>${puntuaciones[2]}</div>
				  </div>
				  <div class="side">
					<div>1 star</div>
				  </div>
				  <div class="middle">
					<div class="bar-container progress m-progress--sm">
						<div class="bar-1 progress-bar m--bg-brand" role="progressbar" width="0%" aria-valuenow="${puntuaciones[1]*calc}" aria-valuemin="0" aria-valuemax="${element.ratings.length}"></div>
					</div>
				  </div>
				  <div class="side right">
					<div>${puntuaciones[1]}</div>
				  </div>
				  <div class="side">
					<div>0 star</div>
				  </div>
				  <div class="middle">
					<div class="bar-container progress m-progress--sm">
						<div class="bar-1 progress-bar m--bg-brand" role="progressbar" width="0%" aria-valuenow="${puntuaciones[0]*calc}" aria-valuemin="0" aria-valuemax="${element.ratings.length}"></div>
					</div>
				  </div>
				  <div class="side right">
					<div>${puntuaciones[0]}</div>
				  </div>
				</div>
			</div>
`;
			$('#ratings').append(val);
			$('#spinnermain').hide();
			animateProgress();
		}
		window.onload = function () {
			init();
		};
		var radioValoracion = 0;
		$(':radio').change(function () {
			radioValoracion = this.value;
			console.log('New star rating: ' + this.value);
		});



		function enviarValoracion() {
	 
			var settings = {
			"url": "https://lab.onesaitplatform.com/api-manager/server/api/v1/Market3d_ratings/insert/",
			"method": "POST",
			"timeout": 0,
			"headers": {
				"accept": "application/json",
				"X-OP-APIKey": "b2fd5ceda7154eecb401886f461a6f0a",
				"Content-Type": "application/json"
			},
			"data": JSON.stringify({"user":"rtvachet","assetId":id,"rating":parseInt(radioValoracion),"comment":$('#comentarioValoracion').val()}),
			};
			$.ajax(settings).fail(function (response) {
				$('#creacionFallida').show();
				console.log(response);
				$('#spinnermain').hide();
			}).done(function (response) {
				$('#creacionCorrecta').show();
				console.log(response);
				$('#spinnermain').hide();
				setTimeout(() => {
					document.location.href = "element.html?id="+id;
				}, 4000);
			});



		}


	// ANIMATED PROGRESS BAR
	function animateProgress(){
	
	var progressBars = $('div.progress-bar');
		progressBars.each(function(ind,bar){
	// set up
	$(bar).attr('width','0px');    
	let currentProgress = $(bar).attr('aria-valuenow'); 
	$(bar).attr('aria-valuenow', 0);
	// animate
		$(bar).animate({ width: currentProgress + '%' }, 500);
	$(bar).attr('aria-valuenow', currentProgress); 

	})
	}

	</script>





</body>

</html>